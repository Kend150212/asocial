// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


// ==========================================
// AUTH & USERS
// ==========================================

enum UserRole {
  ADMIN
  OWNER
  MANAGER
  STAFF
  CUSTOMER
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  emailVerified   DateTime? @map("email_verified")
  passwordHash    String?   @map("password_hash")
  role            UserRole  @default(MANAGER)
  isActive        Boolean   @default(true) @map("is_active")
  image           String?
  lastLoginAt     DateTime? @map("last_login_at")
  inviteToken     String?   @unique @map("invite_token")
  inviteExpiresAt DateTime? @map("invite_expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  trialEndsAt     DateTime? @map("trial_ends_at")

  // Google Drive per-user storage
  gdriveRefreshToken  String?   @map("gdrive_refresh_token") @db.Text
  gdriveFolderId      String?   @map("gdrive_folder_id")
  gdriveFolderName    String?   @map("gdrive_folder_name")
  gdriveEmail         String?   @map("gdrive_email")
  gdriveConnectedAt   DateTime? @map("gdrive_connected_at")

  // Relations
  preference     UserPreference?
  channelMembers ChannelMember[]
  posts          Post[]           @relation("PostAuthor")
  postApprovals  PostApproval[]
  notifications  Notification[]
  activityLogs   ActivityLog[]
  apiKeys        UserApiKey[]
  appApiKeys     AppApiKey[]
  assignedConversations Conversation[]
  subscription   Subscription?

  // NextAuth
  accounts Account[]
  sessions Session[]

  // Platform connections
  channelPlatforms ChannelPlatform[]

  @@map("users")
}

model OtpToken {
  id        String   @id @default(cuid())
  email     String
  code      String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  password  String   // bcrypt hashed
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("otp_tokens")
}

model UserApiKey {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  provider        String   // openai, gemini, anthropic, etc.
  name            String   // Display name e.g. "My OpenAI Key"
  apiKeyEncrypted String   @map("api_key_encrypted") @db.Text
  defaultModel    String?  @map("default_model")
  isDefault       Boolean  @default(false) @map("is_default")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("user_api_keys")
}

model AppApiKey {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  name       String    // "My Production Key"
  keyHash    String    @unique @map("key_hash")
  keyPrefix  String    @map("key_prefix")      // "ask_a1b2c3" for display
  scopes     Json      @default("[\"*\"]")
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("app_api_keys")
}

model UserPreference {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  theme  String @default("dark")
  locale String @default("vi")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==========================================
// API INTEGRATIONS HUB
// ==========================================

enum IntegrationCategory {
  AI
  SOCIAL
  STORAGE
  EMAIL
  WEBHOOK
  DESIGN
  BILLING
  AUTH
}

enum IntegrationStatus {
  ACTIVE
  ERROR
  INACTIVE
}

model ApiIntegration {
  id              String              @id @default(cuid())
  category        IntegrationCategory
  provider        String              // openai, gemini, runware, vbout, gdrive, smtp, slack, discord, telegram
  name            String
  apiKeyEncrypted String?             @map("api_key_encrypted") @db.Text
  baseUrl         String?             @map("base_url")
  config          Json?               @default("{}")
  isActive        Boolean             @default(true) @map("is_active")
  isDefault       Boolean             @default(false) @map("is_default")
  status          IntegrationStatus   @default(ACTIVE)
  lastTestedAt    DateTime?           @map("last_tested_at")
  usageCount      Int                 @default(0) @map("usage_count")
  rateLimitPerSec Int?                @map("rate_limit_per_sec")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  channelOverrides ChannelIntegrationOverride[]

  @@unique([category, provider])
  @@map("api_integrations")
}

model ChannelIntegrationOverride {
  id              String  @id @default(cuid())
  channelId       String  @map("channel_id")
  integrationId   String  @map("integration_id")
  apiKeyEncrypted String? @map("api_key_encrypted") @db.Text
  config          Json?   @default("{}")

  channel     Channel        @relation(fields: [channelId], references: [id], onDelete: Cascade)
  integration ApiIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([channelId, integrationId])
  @@map("channel_integration_overrides")
}

// ==========================================
// CHANNELS
// ==========================================

model Channel {
  id                      String   @id @default(cuid())
  name                    String   @unique
  displayName             String   @map("display_name")
  description             String?  @db.Text
  isActive                Boolean  @default(true) @map("is_active")
  language                String   @default("vi")
  timezone                String   @default("UTC")
  descriptionsPerPlatform Json?    @map("descriptions_per_platform") @default("{}")
  vibeTone                Json?    @map("vibe_tone") @default("{}")
  seoTags                 Json?    @map("seo_tags") @default("[]")
  colorPalette            Json?    @map("color_palette") @default("[]")
  logoPrompts             Json?    @map("logo_prompts") @default("{}")
  bannerPrompts           Json?    @map("banner_prompts") @default("{}")
  notificationEmail       String?  @map("notification_email")
  requireApproval         String   @default("none") @map("require_approval")
  defaultAiProvider       String?  @map("default_ai_provider") // openai, gemini
  defaultAiModel          String?  @map("default_ai_model")
  defaultImageProvider    String?  @map("default_image_provider") // runware, openai, gemini
  defaultImageModel       String?  @map("default_image_model")
  aiApiKeyEncrypted       String?  @map("ai_api_key_encrypted") @db.Text
  requireOwnApiKey        Boolean  @default(true) @map("require_own_api_key")
  newsTopics              Json?    @map("news_topics") @default("[]") // e.g. ["AI", "startup", "SaaS"]
  businessInfo            Json?    @map("business_info") @default("{}") // { phone, address, website, socials: { facebook, instagram, ... , custom: [{label,url}] } }
  brandProfile            Json?    @map("brand_profile") @default("{}") // { targetAudience, contentTypes, brandValues, communicationStyle }

  // Storage
  storageProvider    String?  @map("storage_provider") // gdrive, s3, wasabi, r2
  storageConfig      Json?    @map("storage_config") @default("{}")
  useDefaultStorage  Boolean  @default(true) @map("use_default_storage")

  // Webhooks
  webhookDiscord  Json? @map("webhook_discord") @default("{}")
  webhookTelegram Json? @map("webhook_telegram") @default("{}")
  webhookSlack    Json? @map("webhook_slack") @default("{}")
  webhookZalo     Json? @map("webhook_zalo") @default("{}")
  webhookCustom   Json? @map("webhook_custom") @default("{}")
  webhookEvents   Json? @map("webhook_events") @default("[]")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members              ChannelMember[]
  integrationOverrides ChannelIntegrationOverride[]
  knowledgeBase        KnowledgeBase[]
  contentTemplates     ContentTemplate[]
  hashtagGroups        HashtagGroup[]
  platforms            ChannelPlatform[]
  posts                Post[]
  mediaItems           MediaItem[]
  mediaFolders         MediaFolder[]
  invites              ChannelInvite[]
  conversations        Conversation[]
  socialComments       SocialComment[]
  botConfig            BotConfig?
  easyConnectLinks     EasyConnectLink[]

  @@map("channels")
}

model ChannelMember {
  id        String @id @default(cuid())
  userId    String @map("user_id")
  channelId String @map("channel_id")
  role      UserRole @default(MANAGER)

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  permission ChannelPermission?

  @@unique([userId, channelId])
  @@map("channel_members")
}

model ChannelPermission {
  id              String  @id @default(cuid())
  channelMemberId String  @unique @map("channel_member_id")

  canCreatePost    Boolean @default(true) @map("can_create_post")
  canEditPost      Boolean @default(true) @map("can_edit_post")
  canDeletePost    Boolean @default(false) @map("can_delete_post")
  canApprovePost   Boolean @default(false) @map("can_approve_post")
  canSchedulePost  Boolean @default(true) @map("can_schedule_post")
  canUploadMedia   Boolean @default(true) @map("can_upload_media")
  canDeleteMedia   Boolean @default(false) @map("can_delete_media")
  canViewMedia     Boolean @default(true) @map("can_view_media")
  canCreateEmail   Boolean @default(false) @map("can_create_email")
  canManageContacts Boolean @default(false) @map("can_manage_contacts")
  canViewReports   Boolean @default(true) @map("can_view_reports")
  canEditSettings  Boolean @default(false) @map("can_edit_settings")

  channelMember ChannelMember @relation(fields: [channelMemberId], references: [id], onDelete: Cascade)

  @@map("channel_permissions")
}

model ChannelPlatform {
  id              String    @id @default(cuid())
  channelId       String    @map("channel_id")
  platform        String    // facebook, instagram, x, linkedin, tiktok, youtube, pinterest, gbp, wistia, vimeo
  accountId       String    @map("account_id")
  accountName     String    @map("account_name")
  config          Json?     @default("{}")
  isActive        Boolean   @default(true) @map("is_active")
  accessToken     String?   @map("access_token") @db.Text
  refreshToken    String?   @map("refresh_token") @db.Text
  tokenExpiresAt  DateTime? @map("token_expires_at")
  connectedBy     String?   @map("connected_by")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [connectedBy], references: [id])

  conversations Conversation[]
  socialComments SocialComment[]

  @@unique([channelId, platform, accountId])
  @@map("channel_platforms")
}

model KnowledgeBase {
  id         String   @id @default(cuid())
  channelId  String   @map("channel_id")
  title      String
  sourceType String   @default("text") @map("source_type") // text, url, google_sheet, file
  sourceUrl  String?  @map("source_url")
  content    String   @db.Text
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@map("knowledge_bases")
}

model ContentTemplate {
  id              String  @id @default(cuid())
  channelId       String? @map("channel_id")
  platform        String? // null = all platforms
  name            String
  templateContent String  @map("template_content") @db.Text
  variables       Json?   @default("[]")
  isGlobal        Boolean @default(false) @map("is_global")
  createdAt       DateTime @default(now()) @map("created_at")

  channel Channel? @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@map("content_templates")
}

model HashtagGroup {
  id        String @id @default(cuid())
  channelId String @map("channel_id")
  name      String
  hashtags  Json   @default("[]")
  usageCount Int   @default(0) @map("usage_count")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@map("hashtag_groups")
}

// ==========================================
// POSTS
// ==========================================

enum PostStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

model Post {
  id                 String     @id @default(cuid())
  channelId          String     @map("channel_id")
  authorId           String     @map("author_id")
  content            String?    @db.Text
  contentPerPlatform Json?      @map("content_per_platform") @default("{}")
  status             PostStatus @default(DRAFT)
  scheduledAt        DateTime?  @map("scheduled_at")
  publishedAt        DateTime?  @map("published_at")
  isRepeat           Boolean    @default(false) @map("is_repeat")
  repeatCount        Int?       @map("repeat_count")
  repeatIntervalDays Int?       @map("repeat_interval_days")
  bulkGroupId        String?    @map("bulk_group_id")
  contentHash        String?    @map("content_hash") // duplicate detection
  createdAt          DateTime   @default(now()) @map("created_at")
  updatedAt          DateTime   @updatedAt @map("updated_at")

  channel  Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  author   User    @relation("PostAuthor", fields: [authorId], references: [id])

  media           PostMedia[]
  approvals       PostApproval[]
  platformStatuses PostPlatformStatus[]
  socialComments   SocialComment[]

  @@index([channelId, status])
  @@index([scheduledAt])
  @@map("posts")
}

model PostMedia {
  id          String @id @default(cuid())
  postId      String @map("post_id")
  mediaItemId String @map("media_item_id")
  sortOrder   Int    @default(0) @map("sort_order")

  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  mediaItem MediaItem @relation(fields: [mediaItemId], references: [id])

  @@map("post_media")
}

model PostApproval {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  action    String   // APPROVED | REJECTED
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@map("post_approvals")
}

model PostPlatformStatus {
  id         String   @id @default(cuid())
  postId     String   @map("post_id")
  platform   String
  accountId  String   @map("account_id")
  externalId String?  @map("external_id") // Vbout post ID
  status     String   @default("pending") // pending, published, failed
  errorMsg   String?  @map("error_msg")
  config     Json?    // Platform-specific config: postType, firstComment, carousel, visibility, etc.
  publishedAt DateTime? @map("published_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, platform, accountId])
  @@map("post_platform_statuses")
}

// ==========================================
// CHANNEL INVITES (Customer portal)
// ==========================================

model ChannelInvite {
  id          String    @id @default(cuid())
  channelId   String    @map("channel_id")
  email       String
  name        String?
  token       String    @unique
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  userId      String?   @map("user_id")   // set after invite accepted
  invitedBy   String    @map("invited_by") // staff user id
  createdAt   DateTime  @default(now()) @map("created_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, email])
  @@map("channel_invites")
}

// ==========================================
// EASY CONNECT LINKS
// ==========================================

model EasyConnectLink {
  id           String    @id @default(cuid())
  channelId    String    @map("channel_id")
  title        String                          // e.g. "Link cho client ABC"
  token        String    @unique               // random secure token
  passwordHash String?   @map("password_hash") // optional bcrypt hash
  isEnabled    Boolean   @default(true)        @map("is_enabled")
  expiresAt    DateTime? @map("expires_at")    // null = never expires
  createdBy    String    @map("created_by")
  createdAt    DateTime  @default(now())       @map("created_at")
  updatedAt    DateTime  @updatedAt            @map("updated_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@map("easy_connect_links")
}

// ==========================================
// MEDIA
// ==========================================

model MediaFolder {
  id        String   @id @default(cuid())
  channelId String   @map("channel_id")
  parentId  String?  @map("parent_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  channel  Channel       @relation(fields: [channelId], references: [id], onDelete: Cascade)
  parent   MediaFolder?  @relation("FolderTree", fields: [parentId], references: [id])
  children MediaFolder[] @relation("FolderTree")
  media    MediaItem[]

  @@unique([channelId, parentId, name])
  @@map("media_folders")
}

model MediaItem {
  id            String   @id @default(cuid())
  channelId     String   @map("channel_id")
  folderId      String?  @map("folder_id")
  url           String
  thumbnailUrl  String?  @map("thumbnail_url")
  storageFileId String?  @map("storage_file_id")
  type          String   // image, video
  source        String   // upload, ai_generated, post
  originalName  String?  @map("original_name")
  fileSize      Int?     @map("file_size")
  mimeType      String?  @map("mime_type")
  tags          Json?    @default("[]")
  aiMetadata    Json?    @map("ai_metadata") @default("{}") // provider, model, ratio, prompt
  createdAt     DateTime @default(now()) @map("created_at")

  channel Channel      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  folder  MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  posts   PostMedia[]

  @@index([channelId, type])
  @@index([folderId])
  @@map("media_items")
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String   // post_published, post_failed, approval_needed, approval_approved, approval_rejected
  title     String
  message   String?  @db.Text
  data      Json?    @default("{}")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ==========================================
// ACTIVITY LOG
// ==========================================

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  channelId String?  @map("channel_id")
  action    String   // user_login, post_created, post_approved, settings_changed, etc.
  details   Json?    @default("{}")
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([channelId])
  @@map("activity_logs")
}

// ==========================================
// WEBHOOKS
// ==========================================

model Webhook {
  id       String  @id @default(cuid())
  name     String
  url      String
  platform String  // slack, discord, telegram, custom
  events   Json    @default("[]")
  secret   String?
  isActive Boolean @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("webhooks")
}

// ==========================================
// BACKUP
// ==========================================

enum BackupStatus {
  PENDING
  COMPLETED
  FAILED
}

model Backup {
  id        String       @id @default(cuid())
  type      String       // full, channels, posts
  fileUrl   String?      @map("file_url")
  fileSize  Int?         @map("file_size")
  status    BackupStatus @default(PENDING)
  createdAt DateTime     @default(now()) @map("created_at")

  @@map("backups")
}


// ==========================================
// BILLING & PLANS
// ==========================================

model Plan {
  id          String  @id @default(cuid())
  name        String  // e.g. "Free", "Pro"
  nameVi      String  @default("") @map("name_vi") // e.g. "Miễn phí", "Chuyên nghiệp"
  description String? @db.Text
  descriptionVi String? @map("description_vi") @db.Text
  isActive    Boolean @default(true) @map("is_active")
  isPublic    Boolean @default(true) @map("is_public") // visible on /pricing
  sortOrder   Int     @default(0) @map("sort_order")

  // Stripe
  stripePriceIdMonthly String? @map("stripe_price_id_monthly")
  stripePriceIdAnnual  String? @map("stripe_price_id_annual")

  // Pricing
  priceMonthly Float @default(0) @map("price_monthly")
  priceAnnual  Float @default(0) @map("price_annual")

  // Limits (-1 = unlimited)
  maxChannels          Int @default(1) @map("max_channels")
  maxPostsPerMonth     Int @default(50) @map("max_posts_per_month")
  maxMembersPerChannel Int @default(2) @map("max_members_per_channel")

  // Feature flags
  hasAutoSchedule    Boolean @default(false) @map("has_auto_schedule")
  hasWebhooks        Boolean @default(false) @map("has_webhooks")
  hasAdvancedReports Boolean @default(false) @map("has_advanced_reports")
  hasPrioritySupport Boolean @default(false) @map("has_priority_support")
  hasWhiteLabel      Boolean @default(false) @map("has_white_label")

  // AI Image Generation quota (-1 = unlimited, 0 = BYOK only)
  maxAiImagesPerMonth Int @default(0) @map("max_ai_images_per_month")
  // AI Text Generation quota — 1 unit = 1 generation request (-1 = unlimited, 0 = BYOK only)
  maxAiTextPerMonth   Int @default(20) @map("max_ai_text_per_month")
  // Storage quota in MB (-1 = unlimited). All users must use own GDrive.
  maxStorageMB        Int @default(512) @map("max_storage_mb")
  maxApiCallsPerMonth Int @default(0) @map("max_api_calls_per_month") // 0=no API, -1=unlimited

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique @map("user_id")
  planId               String    @map("plan_id")

  // Stripe
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")
  stripeCouponId       String?   @map("stripe_coupon_id")

  // Billing
  billingInterval      String    @default("monthly") @map("billing_interval") // monthly | annual | lifetime
  status               String    @default("active") @map("status")            // active | past_due | canceled | trialing
  trialEndsAt          DateTime? @map("trial_ends_at")
  currentPeriodEnd     DateTime  @map("current_period_end")
  cancelAtPeriodEnd    Boolean   @default(false) @map("cancel_at_period_end")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan   Plan    @relation(fields: [planId], references: [id])
  usages Usage[]

  @@map("subscriptions")
}

model Usage {
  id             String   @id @default(cuid())
  subscriptionId String   @map("subscription_id")
  month          String   // "2026-02" (YYYY-MM)
  postsCreated    Int @default(0) @map("posts_created")
  imagesGenerated Int @default(0) @map("images_generated")
  aiTextGenerated Int @default(0) @map("ai_text_generated")
  apiCalls        Int @default(0) @map("api_calls")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, month])
  @@map("usages")
}

// ==========================================
// SITE SETTINGS (Whitelabel / Branding)
// ==========================================

model SiteSettings {
  id            String   @id @default("default")
  appName       String   @default("ASocial") @map("app_name")
  tagline       String   @default("Social Media Management")
  logoUrl       String   @default("/logo.png") @map("logo_url")
  faviconUrl    String   @default("/favicon.ico") @map("favicon_url")
  primaryColor  String   @default("#7c3aed") @map("primary_color")
  supportEmail  String   @default("") @map("support_email")
  copyrightText  String   @default("") @map("copyright_text")
  footerLinks    Json     @default("[]") @map("footer_links")
  termsContent   String   @default("") @map("terms_content") @db.Text
  privacyContent String   @default("") @map("privacy_content") @db.Text
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

// ==========================================
// SOCIAL INBOX
// ==========================================

enum ConversationMode {
  BOT
  AGENT
  PAUSED
}

model Conversation {
  id                 String           @id @default(cuid())
  channelId          String           @map("channel_id")
  platformAccountId  String           @map("platform_account_id")
  platform           String
  externalUserId     String           @map("external_user_id")
  externalUserName   String?          @map("external_user_name")
  externalUserAvatar String?          @map("external_user_avatar")
  status             String           @default("new") // new, open, done, archived
  mode               ConversationMode @default(BOT)
  assignedTo         String?          @map("assigned_to")
  tags               Json?            @default("[]")
  sentiment          String?          // positive, neutral, negative
  intent             String?          // buy, support, complaint, info
  type               String           @default("message") // message, comment
  metadata           Json?            // Post context for comments: { postId, postContent, postImages, postPermalink }
  priority           Int              @default(0)
  aiSummary          String?          @map("ai_summary") @db.Text
  lastMessageAt      DateTime?        @map("last_message_at")
  unreadCount        Int              @default(0) @map("unread_count")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  channel         Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  agent           User?           @relation(fields: [assignedTo], references: [id])
  platformAccount ChannelPlatform @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)
  messages        InboxMessage[]

  @@unique([channelId, platform, externalUserId])
  @@index([channelId, status])
  @@index([platformAccountId])
  @@map("conversations")
}

model InboxMessage {
  id              String   @id @default(cuid())
  conversationId  String   @map("conversation_id")
  externalId      String?  @map("external_id")
  direction       String   // inbound, outbound
  senderType      String   @default("customer") @map("sender_type") // customer, bot, agent
  content         String   @db.Text
  contentOriginal String?  @map("content_original") @db.Text
  detectedLang    String?  @map("detected_lang")
  mediaUrl        String?  @map("media_url")
  mediaType       String?  @map("media_type")
  senderName      String?  @map("sender_name")
  senderAvatar    String?  @map("sender_avatar")
  confidence      Float?
  sentAt          DateTime @default(now()) @map("sent_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, sentAt])
  @@map("inbox_messages")
}

model SocialComment {
  id                String    @id @default(cuid())
  channelId         String    @map("channel_id")
  platformAccountId String    @map("platform_account_id")
  postId            String?   @map("post_id")
  platform          String
  externalPostId    String    @map("external_post_id")
  externalCommentId String    @unique @map("external_comment_id")
  parentCommentId   String?   @map("parent_comment_id")
  authorName        String    @map("author_name")
  authorAvatar      String?   @map("author_avatar")
  content           String    @db.Text
  sentiment         String?
  isSpam            Boolean   @default(false) @map("is_spam")
  status            String    @default("new") // new, replied, hidden, archived
  replyContent      String?   @map("reply_content") @db.Text
  repliedBy         String?   @map("replied_by")
  repliedAt         DateTime? @map("replied_at")
  commentedAt       DateTime  @map("commented_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  channel         Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  platformAccount ChannelPlatform @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)
  post            Post?           @relation(fields: [postId], references: [id])

  @@index([channelId, status])
  @@map("social_comments")
}

model BotConfig {
  id              String  @id @default(cuid())
  channelId       String  @unique @map("channel_id")
  isEnabled       Boolean @default(true) @map("is_enabled")
  botName         String  @default("AI Assistant") @map("bot_name")
  greeting        String? @db.Text
  greetingMode    String  @default("template") @map("greeting_mode") // template | auto
  greetingImages  Json?   @default("[]") @map("greeting_images") // Array of image URLs
  personality     String? @db.Text
  language        String  @default("vi")

  // Image library & video consultation
  imageFolderId   String? @map("image_folder_id") // Drive folder for bot images
  consultVideos   Json?   @default("[]") @map("consult_videos") // [{title, url, description}]

  // AI behavior
  confidenceThreshold Float   @default(0.7) @map("confidence_threshold")
  maxBotReplies       Int     @default(10) @map("max_bot_replies")
  autoTagEnabled      Boolean @default(true) @map("auto_tag_enabled")
  sentimentEnabled    Boolean @default(true) @map("sentiment_enabled")
  spamFilterEnabled   Boolean @default(true) @map("spam_filter_enabled")
  autoTranslate       Boolean @default(false) @map("auto_translate")
  smartAssignEnabled  Boolean @default(false) @map("smart_assign_enabled")

  // Escalation
  autoEscalateKeywords Json? @default("[]") @map("auto_escalate_keywords")
  forbiddenTopics      Json? @default("[]") @map("forbidden_topics")

  // Working hours
  workingHoursOnly  Boolean @default(false) @map("working_hours_only")
  workingHoursStart String? @map("working_hours_start")
  workingHoursEnd   String? @map("working_hours_end")
  offHoursMessage   String? @map("off_hours_message") @db.Text

  // Training
  trainingPairs Json? @default("[]") @map("training_pairs")
  exampleConvos Json? @default("[]") @map("example_convos")

  // Scope
  enabledPlatforms Json?   @default("[\"all\"]") @map("enabled_platforms")
  applyToComments  Boolean @default(true) @map("apply_to_comments")
  applyToMessages  Boolean @default(true) @map("apply_to_messages")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@map("bot_configs")
}

